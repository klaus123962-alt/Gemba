<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ß–µ–∫-–ª–∏—Å—Ç –æ–±—Ö–æ–¥–∞</title>

<!-- ExcelJS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root { --main:#001355; }

body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
    background:#f5f5f5;
}

.container{
    max-width:1200px;
    margin:0 auto;
    background:#fff;
    padding:15px;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
}

/* ===== HEADER ===== */
header{
    background:var(--main);
    color:#fff;
    border-radius:8px;
    padding:15px;
}

.header-top{
    display:flex;
    align-items:center;
    gap:15px;
}

.logo{ height:42px; }

.header-title{
    flex:1;
    text-align:center;
}

.header-title h1{
    margin:0;
    font-size:20px;
}

.header-title p{
    margin:4px 0 0;
    font-size:14px;
    opacity:.9;
}

/* ===== ROUTE BLOCK ===== */
.route-block{
    margin-top:20px;
    padding:15px;
    border:2px solid var(--main);
    border-radius:8px;
    background:#f9f9f9;
}

.route-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:15px;
}

label{
    font-weight:600;
    font-size:14px;
    display:block;
    margin-bottom:5px;
}

input, select, textarea, button{
    width:100%;
    padding:12px;
    font-size:15px;
    border-radius:6px;
    border:2px solid #ddd;
    box-sizing:border-box;
}

textarea{ resize:vertical; }

button{
    background:var(--main);
    color:#fff;
    border:none;
    cursor:pointer;
    margin-bottom:5px;
    transition:background 0.3s;
}

button:hover{
    background:#002677;
}

button:disabled{
    background:#cccccc;
    cursor:not-allowed;
}

.actions{
    display:flex;
    gap:10px;
    margin-top:15px;
}

/* ===== REMARK ACCORDION ===== */
.remark{
    margin-top:15px;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,.1);
    border:1px solid #e0e0e0;
}

.remark-header{
    background:#e9ecf3;
    padding:12px;
    font-weight:700;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.remark-header:hover{
    background:#dfe4f0;
}

.remark-body{
    padding:15px;
    background:#fff;
}

.remark.collapsed .remark-body{
    display:none;
}

video{
    width:100%;
    max-width:400px;
    border-radius:8px;
    margin-bottom:10px;
    border:2px solid #ddd;
    background:#000;
}

.photo-preview{
    margin:10px 0;
    text-align:center;
}

.photo-preview img{
    max-width:250px;
    max-height:200px;
    border-radius:4px;
    margin:5px;
    border:2px solid var(--main);
    object-fit:cover;
    cursor:zoom-in;
    transition:transform 0.3s;
}

.photo-preview img:hover{
    transform:scale(1.05);
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ */
.photo-modal {
    display:none;
    position:fixed;
    z-index:1000;
    left:0;
    top:0;
    width:100%;
    height:100%;
    background-color:rgba(0,0,0,0.9);
    justify-content:center;
    align-items:center;
}

.photo-modal-content {
    max-width:90%;
    max-height:90%;
}

.photo-modal-content img {
    width:100%;
    height:auto;
    border-radius:8px;
}

.close-modal {
    position:absolute;
    top:20px;
    right:35px;
    color:#f1f1f1;
    font-size:40px;
    font-weight:bold;
    cursor:pointer;
}

.close-modal:hover {
    color:#bbb;
}

/* ===== RECORDING STATUS ===== */
.recording-status{
    background:#fff3e0;
    color:#ef6c00;
    padding:10px 12px;
    border-radius:4px;
    margin:10px 0;
    display:none;
    font-size:14px;
    border-left:4px solid #ff9800;
}

@keyframes pulse{
    0%{ opacity:0.8; }
    50%{ opacity:1; }
    100%{ opacity:0.8; }
}

.recording-status.recording{
    animation:pulse 1.5s infinite;
}

.voice-controls{
    display:flex;
    gap:8px;
    margin-bottom:10px;
    flex-wrap:wrap;
}

.voice-controls button{
    flex:1;
    min-width:120px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∑–∞–º–µ–Ω—ã —Ç–µ–∫—Å—Ç–∞ */
.text-replace-mode {
    background: #e3f2fd !important;
    color: #1565c0 !important;
    border: 2px solid #1565c0 !important;
}

.replace-controls {
    display: flex;
    gap: 8px;
    margin: 10px 0;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 6px;
    display: none;
}

.replace-controls button {
    flex: 1;
    padding: 8px;
    font-size: 14px;
}

/* ===== MOBILE ===== */
@media(max-width:768px){
    .route-grid{ grid-template-columns:1fr; }
    .voice-controls{ flex-direction:column; }
    .voice-controls button{ width:100%; min-width:auto; }
    video{ max-width:100%; }
    .photo-preview img{ max-width:200px; max-height:150px; }
}

.loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
}

.loading-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #001355;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
<div id="photoModal" class="photo-modal">
    <span class="close-modal">&times;</span>
    <div class="photo-modal-content">
        <img id="modalImage" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
    </div>
</div>

<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div>–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏...</div>
</div>

<div class="container">

<header>
    <div class="header-top">
        <img src="http://irtz.ru/PC/pc.png" class="logo" alt="–õ–æ–≥–æ—Ç–∏–ø">
        <div class="header-title">
            <h1>–ß–ï–ö-–õ–ò–°–¢ –û–ë–•–û–î–ê</h1>
            <p>–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å</p>
        </div>
    </div>
</header>

<div class="route-block">
    <div class="route-grid">
        <div>
            <label>–î–∞—Ç–∞ –æ–±—Ö–æ–¥–∞</label>
            <input type="date" id="date" value="">
        </div>
        <div>
            <label>–ì—Ä—É–ø–ø–∞</label>
            <select id="group">
                <option>–ì—Ä—É–ø–ø–∞ 1</option>
                <option>–ì—Ä—É–ø–ø–∞ 2</option>
                <option>–ì—Ä—É–ø–ø–∞ 3</option>
                <option>–ì—Ä—É–ø–ø–∞ 4</option>
                <option>–ì—Ä—É–ø–ø–∞ 5</option>
            </select>
        </div>
        <div>
            <label>–ú–∞—Ä—à—Ä—É—Ç –æ–±—Ö–æ–¥–∞</label>
            <select id="route">
                <option>–ú–∞—Ä—à—Ä—É—Ç 1 ‚Äî –ì–ª–∞–≤–Ω—ã–π –∫–æ—Ä–ø—É—Å</option>
                <option>–ú–∞—Ä—à—Ä—É—Ç 2 ‚Äî –≠–ª–µ–∫—Ç—Ä–æ—â–∏—Ç–æ–≤—ã–µ</option>
                <option>–ú–∞—Ä—à—Ä—É—Ç 3 ‚Äî –ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä–Ω–∞—è</option>
                <option>–ú–∞—Ä—à—Ä—É—Ç 4 ‚Äî –°–∫–ª–∞–¥ –ì–°–ú</option>
                <option>–ú–∞—Ä—à—Ä—É—Ç 5 ‚Äî –ù–∞—Å–æ—Å–Ω–∞—è</option>
                <option>–ú–∞—Ä—à—Ä—É—Ç 6 ‚Äî –ö–æ—Ç–µ–ª—å–Ω–∞—è</option>
                <option>–ú–∞—Ä—à—Ä—É—Ç 7 ‚Äî –í–Ω–µ—à–Ω–∏–π –ø–µ—Ä–∏–º–µ—Ç—Ä</option>
            </select>
        </div>
    </div>
</div>

<div id="remarks"></div>

<div class="actions">
    <button onclick="addRemark()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ</button>
    <button onclick="exportExcelWithImages()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel —Å —Ñ–æ—Ç–æ</button>
</div>

</div>

<script>
let remarkCount = 0;
const recognitions = new Map();
// –•—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–º–µ—á–∞–Ω–∏—è
const voiceStates = new Map();

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –¥–ª—è —Ñ–æ—Ç–æ
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('photoModal');
    const closeBtn = document.querySelector('.close-modal');
    
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }
    
    modal.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ
function zoomPhoto(imgElement) {
    const modal = document.getElementById('photoModal');
    const modalImg = document.getElementById('modalImage');
    modalImg.src = imgElement.src;
    modal.style.display = 'flex';
}

function collapseAll(){
    document.querySelectorAll(".remark").forEach(r => r.classList.add("collapsed"));
}

function toggleRemark(header){
    const remark = header.parentElement;
    collapseAll();
    remark.classList.remove("collapsed");
}

function closeRemark(button){
    const remark = button.closest(".remark");
    const video = remark.querySelector('video');
    
    if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
    
    const remarkId = remark.id;
    if (recognitions.has(remarkId)) {
        const rec = recognitions.get(remarkId);
        if (rec) {
            rec.stop();
        }
        recognitions.delete(remarkId);
    }
    
    // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    voiceStates.delete(remarkId);
    
    remark.remove();
}

function addRemark(){
    collapseAll();
    remarkCount++;

    const remarkId = `remark-${remarkCount}`;
    
    const r = document.createElement("div");
    r.className = "remark";
    r.id = remarkId;

    r.innerHTML = `
        <div class="remark-header" onclick="toggleRemark(this)">
            <span>–ó–∞–º–µ—á–∞–Ω–∏–µ ‚Ññ${remarkCount}</span>
            <button onclick="closeRemark(this)" style="width:auto; padding:6px 12px; background:#dc3545; font-size:12px;">‚úï –£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <div class="remark-body">

            <label>–§–æ—Ç–æ (–∫–∞–º–µ—Ä–∞)</label>
            <video id="video-${remarkCount}" autoplay playsinline></video>
            <button onclick="takePhoto(${remarkCount})" id="photo-btn-${remarkCount}">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <div class="photo-preview" id="photo-preview-${remarkId}"></div>

            <label>–ì–æ–ª–æ—Å–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
            <div class="recording-status" id="status-${remarkId}"></div>
            <div class="voice-controls">
                <button onclick="startVoiceInput('${remarkId}')" id="start-btn-${remarkId}">üéô –ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</button>
                <button onclick="stopVoiceInput('${remarkId}')" id="stop-btn-${remarkId}" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <button onclick="clearVoiceInput('${remarkId}')" id="clear-btn-${remarkId}">üóë –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            </div>
            
            <div class="replace-controls" id="replace-controls-${remarkId}">
                <button onclick="addToExistingText('${remarkId}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫ —Ç–µ–∫—Å—Ç—É</button>
                <button onclick="replaceExistingText('${remarkId}')">üîÑ –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            </div>

            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="description-${remarkId}" placeholder="–¢–µ–∫—Å—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–æ–º –≤–≤–æ–¥–µ..."></textarea>

            <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
            <select id="responsible-${remarkCount}" onchange="toggleCustomInput(this, '${remarkId}')">
                <option>–ù–æ–≤–∏–∫–æ–≤</option>
                <option>–°–≤–∏–Ω–∏–Ω</option>
                <option>–¢–∏–º–æ—Ñ–µ–µ–≤</option>
                <option>–°–∞–≤—Ä–∞—Å–æ–≤</option>
                <option>–≠–ø–æ–≤</option>
                <option value="custom">–î—Ä—É–≥–æ–µ</option>
            </select>
            <input id="custom-responsible-${remarkId}" placeholder="–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é" style="display:none; margin-top:5px;">

        </div>
    `;

    document.getElementById("remarks").appendChild(r);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
    initCamera(remarkCount);
}

function initCamera(remarkNumber) {
    const videoId = `video-${remarkNumber}`;
    const video = document.getElementById(videoId);
    
    if (!video) return;
    
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
    
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
        } 
    })
    .then(stream => {
        video.srcObject = stream;
        video.play().catch(e => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:", e));
    })
    .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
        video.style.display = "none";
        const btn = document.getElementById(`photo-btn-${remarkNumber}`);
        if (btn) {
            btn.disabled = true;
            btn.textContent = "üì∑ –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞";
        }
    });
}

function takePhoto(remarkNumber) {
    const videoId = `video-${remarkNumber}`;
    const video = document.getElementById(videoId);
    const remarkId = `remark-${remarkNumber}`;
    const preview = document.getElementById(`photo-preview-${remarkId}`);
    const remark = document.getElementById(remarkId);
    
    if (!video || !video.videoWidth || video.videoWidth === 0) {
        alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –∫–∞–º–µ—Ä–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.");
        return;
    }
    
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ –∫–∞–∫ Data URL (–¥–ª—è –ø—Ä–µ–≤—å—é)
    const photoDataUrl = canvas.toDataURL('image/jpeg', 0.9);
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–≤–µ–ª–∏—á–µ–Ω–∏—è
    const img = document.createElement('img');
    img.src = photoDataUrl;
    img.alt = `–§–æ—Ç–æ –∑–∞–º–µ—á–∞–Ω–∏—è ${remarkNumber}`;
    img.onclick = function() { zoomPhoto(this); };
    
    preview.innerHTML = '';
    preview.appendChild(img);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ –≤ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
    remark.setAttribute('data-photo-base64', photoDataUrl);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ Blob –¥–ª—è Excel (–±–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞)
    canvas.toBlob(function(blob) {
        const reader = new FileReader();
        reader.onloadend = function() {
            remark.setAttribute('data-photo-blob', reader.result);
        };
        reader.readAsDataURL(blob);
    }, 'image/jpeg', 0.9);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.getElementById(`photo-btn-${remarkNumber}`);
    btn.textContent = 'üì∑ –§–æ—Ç–æ —Å–¥–µ–ª–∞–Ω–æ';
    btn.disabled = true;
}

function toggleCustomInput(select, remarkId){
    const customInput = document.getElementById(`custom-responsible-${remarkId}`);
    customInput.style.display = select.value === "custom" ? "block" : "none";
}

// –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–û–ï –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –†–ï–ß–ò
function startVoiceInput(remarkId) {
    const statusDiv = document.getElementById(`status-${remarkId}`);
    const startBtn = document.getElementById(`start-btn-${remarkId}`);
    const stopBtn = document.getElementById(`stop-btn-${remarkId}`);
    const clearBtn = document.getElementById(`clear-btn-${remarkId}`);
    const textarea = document.getElementById(`description-${remarkId}`);
    const replaceControls = document.getElementById(`replace-controls-${remarkId}`);
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Edge.");
        return;
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
    if (recognitions.has(remarkId)) {
        const oldRec = recognitions.get(remarkId);
        if (oldRec) {
            oldRec.stop();
        }
        recognitions.delete(remarkId);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–º–µ—á–∞–Ω–∏—è
    if (!voiceStates.has(remarkId)) {
        voiceStates.set(remarkId, {
            currentText: textarea.value || '',
            tempText: '',
            isRecording: false,
            shouldReplace: false,
            timeoutId: null
        });
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    const recognition = new SpeechRecognition();
    recognition.lang = 'ru-RU';
    recognition.interimResults = true;
    recognition.continuous = true; // –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∑–∞–ø–∏—Å—å
    recognition.maxAlternatives = 1;
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–∞–ø–∏—Å–∏
    const state = voiceStates.get(remarkId);
    state.tempText = '';
    state.isRecording = true;
    state.shouldReplace = false;
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
    if (state.timeoutId) {
        clearTimeout(state.timeoutId);
    }
    
    recognition.onstart = function() {
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'üé§ –°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å. –ó–∞–ø–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è';
        statusDiv.style.background = "#fff3e0";
        statusDiv.style.color = "#ef6c00";
        statusDiv.classList.add('recording');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        clearBtn.disabled = true;
        replaceControls.style.display = 'none';
        
        // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω
        if (textarea.value.trim()) {
            textarea.classList.add('text-replace-mode');
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        state.timeoutId = setTimeout(() => {
            if (state.isRecording) {
                statusDiv.textContent = 'üé§ –ó–∞–ø–∏—Å—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è... –ì–æ–≤–æ—Ä–∏—Ç–µ –¥–∞–ª—å—à–µ';
            }
        }, 5000);
    };
    
    recognition.onresult = function(event) {
        const state = voiceStates.get(remarkId);
        if (!state) return;
        
        let finalTranscript = '';
        let interimTranscript = '';
        
        // –°–æ–±–∏—Ä–∞–µ–º –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        for (let i = 0; i < event.results.length; i++) {
            const result = event.results[i];
            const transcript = result[0].transcript.trim();
            
            if (result.isFinal) {
                finalTranscript += (finalTranscript ? ' ' : '') + transcript;
            } else {
                interimTranscript += (interimTranscript ? ' ' : '') + transcript;
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        state.tempText = finalTranscript || interimTranscript;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        if (state.tempText) {
            textarea.value = state.tempText;
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if (state.timeoutId) {
            clearTimeout(state.timeoutId);
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç
        state.timeoutId = setTimeout(() => {
            if (state.isRecording && recognition) {
                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
                try {
                    recognition.stop();
                    setTimeout(() => {
                        if (state.isRecording) {
                            recognition.start();
                            statusDiv.textContent = 'üé§ –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å–ª—É—à–∞—Ç—å...';
                        }
                    }, 100);
                } catch (e) {
                    console.log("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏");
                }
            }
        }, 3000);
    };
    
    recognition.onerror = function(event) {
        console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:", event.error);
        const state = voiceStates.get(remarkId);
        
        if (event.error === 'no-speech') {
            statusDiv.textContent = "–†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å–ª—É—à–∞—Ç—å...";
            // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å
            setTimeout(() => {
                if (state && state.isRecording && recognition) {
                    try {
                        recognition.start();
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
                    }
                }
            }, 500);
            return;
        } else if (event.error === 'audio-capture') {
            statusDiv.textContent = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
        } else if (event.error === 'not-allowed') {
            statusDiv.textContent = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω";
        } else {
            statusDiv.textContent = "–û—à–∏–±–∫–∞: " + event.error;
        }
        
        statusDiv.style.background = "#ffebee";
        statusDiv.style.color = "#d32f2f";
        statusDiv.classList.remove('recording');
        
        startBtn.disabled = false;
        stopBtn.disabled = true;
        clearBtn.disabled = false;
        
        if (state) {
            state.isRecording = false;
            if (state.timeoutId) {
                clearTimeout(state.timeoutId);
            }
        }
        
        recognitions.delete(remarkId);
        textarea.classList.remove('text-replace-mode');
    };
    
    recognition.onend = function() {
        const state = voiceStates.get(remarkId);
        if (!state) return;
        
        // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –≤ —Ä–µ–∂–∏–º–µ –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
        if (state.isRecording) {
            setTimeout(() => {
                if (state.isRecording && !recognitions.has(remarkId)) {
                    try {
                        recognition.start();
                        return; // –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø–∏—Å—å
                    } catch (e) {
                        console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å");
                    }
                }
            }, 100);
            return;
        }
        
        state.isRecording = false;
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±–æ—Ä
        if (state.tempText && state.tempText.trim()) {
            statusDiv.textContent = "–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";
            statusDiv.style.background = "#e8f5e9";
            statusDiv.style.color = "#2e7d32";
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
            replaceControls.style.display = 'flex';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
            state.currentText = textarea.value;
        } else {
            // –ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ - –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ–º
            statusDiv.style.display = 'none';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            clearBtn.disabled = false;
        }
        
        statusDiv.classList.remove('recording');
        textarea.classList.remove('text-replace-mode');
        
        // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç
        if (state.timeoutId) {
            clearTimeout(state.timeoutId);
            state.timeoutId = null;
        }
        
        recognitions.delete(remarkId);
    };
    
    recognitions.set(remarkId, recognition);
    
    try {
        recognition.start();
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:", error);
        statusDiv.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ";
        statusDiv.style.display = 'block';
        statusDiv.style.background = "#ffebee";
        statusDiv.style.color = "#d32f2f";
        
        if (state) {
            state.isRecording = false;
        }
    }
}

function addToExistingText(remarkId) {
    const textarea = document.getElementById(`description-${remarkId}`);
    const state = voiceStates.get(remarkId);
    const replaceControls = document.getElementById(`replace-controls-${remarkId}`);
    
    if (state && state.tempText) {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É
        const currentText = state.currentText || '';
        const newText = state.tempText.trim();
        
        if (currentText && newText) {
            textarea.value = currentText + ' ' + newText;
        } else if (newText) {
            textarea.value = newText;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        state.currentText = textarea.value;
        state.tempText = '';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
    replaceControls.style.display = 'none';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    const statusDiv = document.getElementById(`status-${remarkId}`);
    const startBtn = document.getElementById(`start-btn-${remarkId}`);
    const stopBtn = document.getElementById(`stop-btn-${remarkId}`);
    const clearBtn = document.getElementById(`clear-btn-${remarkId}`);
    
    statusDiv.style.display = 'none';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    clearBtn.disabled = false;
}

function replaceExistingText(remarkId) {
    const textarea = document.getElementById(`description-${remarkId}`);
    const state = voiceStates.get(remarkId);
    const replaceControls = document.getElementById(`replace-controls-${remarkId}`);
    
    if (state && state.tempText) {
        // –ó–∞–º–µ–Ω—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –Ω–æ–≤—ã–º
        textarea.value = state.tempText.trim();
        state.currentText = textarea.value;
        state.tempText = '';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
    replaceControls.style.display = 'none';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    const statusDiv = document.getElementById(`status-${remarkId}`);
    const startBtn = document.getElementById(`start-btn-${remarkId}`);
    const stopBtn = document.getElementById(`stop-btn-${remarkId}`);
    const clearBtn = document.getElementById(`clear-btn-${remarkId}`);
    
    statusDiv.style.display = 'none';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    clearBtn.disabled = false;
}

function stopVoiceInput(remarkId){
    const state = voiceStates.get(remarkId);
    if (state) {
        state.isRecording = false;
        if (state.timeoutId) {
            clearTimeout(state.timeoutId);
            state.timeoutId = null;
        }
    }
    
    if (recognitions.has(remarkId)) {
        const recognition = recognitions.get(remarkId);
        if (recognition) {
            recognition.stop();
        }
        recognitions.delete(remarkId);
    }
    
    const statusDiv = document.getElementById(`status-${remarkId}`);
    const startBtn = document.getElementById(`start-btn-${remarkId}`);
    const stopBtn = document.getElementById(`stop-btn-${remarkId}`);
    const clearBtn = document.getElementById(`clear-btn-${remarkId}`);
    const textarea = document.getElementById(`description-${remarkId}`);
    const replaceControls = document.getElementById(`replace-controls-${remarkId}`);
    
    statusDiv.style.display = 'none';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    clearBtn.disabled = false;
    replaceControls.style.display = 'none';
    textarea.classList.remove('text-replace-mode');
}

function clearVoiceInput(remarkId){
    const textarea = document.getElementById(`description-${remarkId}`);
    textarea.value = '';
    
    const state = voiceStates.get(remarkId);
    if (state) {
        state.currentText = '';
        state.tempText = '';
    }
}

// –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –≠–ö–°–ü–û–†–¢–ê –° –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø–ú–ò –ò –í–´–ü–ê–î–ê–Æ–©–ò–ú–ò –°–ü–ò–°–ö–ê–ú–ò
async function exportExcelWithImages() {
    const date = document.getElementById("date").value || new Date().toISOString().split('T')[0];
    const group = document.getElementById("group").value || "–ù–µ —É–∫–∞–∑–∞–Ω–∞";
    const route = document.getElementById("route").value || "–ù–µ —É–∫–∞–∑–∞–Ω";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('loading').style.display = 'flex';
    
    try {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É Excel
        const workbook = new ExcelJS.Workbook();
        workbook.creator = '–ß–µ–∫-–ª–∏—Å—Ç –æ–±—Ö–æ–¥–∞';
        workbook.created = new Date();
        
        // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
        const worksheet = workbook.addWorksheet('–û—Ç—á–µ—Ç');
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á–µ—Ç–∞
        worksheet.mergeCells('A1:F1');
        const titleRow = worksheet.getRow(1);
        titleRow.getCell(1).value = '–ß–ï–ö-–õ–ò–°–¢ –û–ë–•–û–î–ê';
        titleRow.getCell(1).font = { size: 16, bold: true, color: { argb: 'FF001355' } };
        titleRow.getCell(1).alignment = { horizontal: 'center' };
        titleRow.height = 25;
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–µ
        worksheet.getCell('A2').value = '–î–∞—Ç–∞ –æ–±—Ö–æ–¥–∞:';
        worksheet.getCell('B2').value = date;
        worksheet.getCell('A3').value = '–ì—Ä—É–ø–ø–∞:';
        worksheet.getCell('B3').value = group;
        worksheet.getCell('A4').value = '–ú–∞—Ä—à—Ä—É—Ç:';
        worksheet.getCell('B4').value = route;
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        worksheet.getRow(6).values = ['‚Ññ', '–§–æ—Ç–æ', '–û–ø–∏—Å–∞–Ω–∏–µ', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–°—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è', '–°—Ç–∞—Ç—É—Å'];
        const headerRow = worksheet.getRow(6);
        headerRow.font = { bold: true };
        headerRow.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE9ECF3' }
        };
        headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
        headerRow.height = 30;
        
        // –£–í–ï–õ–ò–ß–ò–í–ê–ï–ú –®–ò–†–ò–ù–£ –ö–û–õ–û–ù–û–ö –î–õ–Ø –§–û–¢–û –ò –í–´–†–ê–í–ù–ò–í–ê–ï–ú
        worksheet.columns = [
            { width: 8 },   // ‚Ññ
            { width: 45 },  // –§–æ—Ç–æ (–£–í–ï–õ–ò–ß–ï–ù–û —Å 35 –¥–æ 45)
            { width: 60 },  // –û–ø–∏—Å–∞–Ω–∏–µ
            { width: 25 },  // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É)
            { width: 20 },  // –°—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è (–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É)
            { width: 20 }   // –°—Ç–∞—Ç—É—Å (–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É)
        ];
        
        // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
        const statusOptions = ['–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–í —Ä–∞–±–æ—Ç–µ', '–ù–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ', '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'];
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const remarks = document.querySelectorAll(".remark");
        let currentRow = 7; // –ù–∞—á–∏–Ω–∞–µ–º —Å 7 —Å—Ç—Ä–æ–∫–∏
        
        for (let i = 0; i < remarks.length; i++) {
            const remark = remarks[i];
            const remarkId = remark.id;
            const remarkNumber = i + 1;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const desc = document.getElementById(`description-${remarkId}`)?.value || "(–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è)";
            const sel = document.getElementById(`responsible-${remarkNumber}`);
            const customInput = document.getElementById(`custom-responsible-${remarkId}`);
            const resp = sel && sel.value === "custom" ? (customInput?.value || "–ù–µ —É–∫–∞–∑–∞–Ω") : (sel?.value || "–ù–µ —É–∫–∞–∑–∞–Ω");
            
            const hasPhoto = remark.hasAttribute('data-photo-blob');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É
            const row = worksheet.getRow(currentRow);
            row.getCell(1).value = remarkNumber; // ‚Ññ
            row.getCell(3).value = desc; // –û–ø–∏—Å–∞–Ω–∏–µ
            row.getCell(4).value = resp; // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
            row.getCell(5).value = ""; // –°—Ä–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
            row.getCell(6).value = "–ù–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ"; // –°—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ (–£–í–ï–õ–ò–ß–ï–ù–û –¥–ª—è —Ñ–æ—Ç–æ)
            row.height = 150; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–æ—Ç–æ
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫
            for (let col = 1; col <= 6; col++) {
                const cell = row.getCell(col);
                if (col !== 3) { // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ –æ–ø–∏—Å–∞–Ω–∏—é (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞)
                    cell.alignment = { 
                        horizontal: 'center', 
                        vertical: 'middle',
                        wrapText: true
                    };
                } else {
                    // –î–ª—è –æ–ø–∏—Å–∞–Ω–∏—è - –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö—É
                    cell.alignment = { 
                        vertical: 'top',
                        wrapText: true
                    };
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            const statusCell = row.getCell(6);
            
            // –°–æ–∑–¥–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            statusCell.dataValidation = {
                type: 'list',
                allowBlank: false,
                formulae: [`"${statusOptions.join(',')}"`],
                showErrorMessage: true,
                errorStyle: 'warning',
                errorTitle: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å',
                error: '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞: –í—ã–ø–æ–ª–Ω–µ–Ω–æ, –í —Ä–∞–±–æ—Ç–µ, –ù–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ, –û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (hasPhoto) {
                const photoBlob = remark.getAttribute('data-photo-blob');
                
                try {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º base64 –≤ buffer
                    const base64Data = photoBlob.split(',')[1];
                    const imageBuffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Excel
                    const imageId = workbook.addImage({
                        buffer: imageBuffer,
                        extension: 'jpeg'
                    });
                    
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —è—á–µ–π–∫—É B (–∫–æ–ª–æ–Ω–∫–∞ 2)
                    // –£–í–ï–õ–ò–ß–ò–í–ê–ï–ú –†–ê–ó–ú–ï–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
                    worksheet.addImage(imageId, {
                        tl: { col: 1, row: currentRow - 1 }, // –ö–æ–ª–æ–Ω–∫–∞ B (–∏–Ω–¥–µ–∫—Å 1)
                        br: { col: 2, row: currentRow }, // –ó–∞–Ω–∏–º–∞–µ—Ç 2 –∫–æ–ª–æ–Ω–∫–∏
                        ext: { width: 300, height: 200 } // –£–í–ï–õ–ò–ß–ï–ù–ù–´–ô —Ä–∞–∑–º–µ—Ä (300x200)
                    });
                    
                    row.getCell(2).value = "–§–æ—Ç–æ";
                    row.getCell(2).alignment = { 
                        vertical: 'bottom',
                        horizontal: 'center'
                    };
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ:", error);
                    row.getCell(2).value = "–û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ";
                }
            } else {
                row.getCell(2).value = "–ù–µ—Ç —Ñ–æ—Ç–æ";
                row.getCell(2).alignment = { 
                    vertical: 'middle', 
                    horizontal: 'center' 
                };
            }
            
            currentRow++;
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü–µ
        for (let i = 6; i < currentRow; i++) {
            const row = worksheet.getRow(i);
            for (let j = 1; j <= 6; j++) {
                const cell = row.getCell(j);
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FF001355' } },
                    left: { style: 'thin', color: { argb: 'FF001355' } },
                    bottom: { style: 'thin', color: { argb: 'FF001355' } },
                    right: { style: 'thin', color: { argb: 'FF001355' } }
                };
            }
        }
        
        // –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫
        worksheet.views = [
            { state: 'normal', showGridLines: true }
        ];
        
        // –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        const fileName = `–ß–µ–∫-–ª–∏—Å—Ç_–æ–±—Ö–æ–¥–∞_${date}_${group.replace(/\s+/g, '_')}.xlsx`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        
        saveAs(blob, fileName);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('loading').style.display = 'none';
        
        // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
        alert(`–û—Ç—á–µ—Ç "${fileName}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.\n–í—Å–µ–≥–æ –∑–∞–º–µ—á–∞–Ω–∏–π: ${remarks.length}`);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel:", error);
        document.getElementById('loading').style.display = 'none';
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
    }
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
window.addEventListener('beforeunload', function() {
    recognitions.forEach((recognition) => {
        if (recognition) {
            recognition.stop();
        }
    });
    
    document.querySelectorAll('video').forEach(video => {
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
    });
});
</script>

</body>
</html>
